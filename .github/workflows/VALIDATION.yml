name: PR Validation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  analyze-pr-description:
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.save-pr-info.outputs.pr_number }}
      language: ${{ steps.save-pr-info.outputs.language }}
      marked_exercises: ${{ steps.save-pr-info.outputs.marked_exercises }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Run analyze-pr-description script
        id: analyze-pr
        run: |
          chmod +x ./scripts/analyze-pr-description.sh
          ./scripts/analyze-pr-description.sh "${{ github.event.pull_request.body }}" # Pasa el cuerpo del PR como parámetro

      - name: Upload PR information as artifact
        uses: actions/upload-artifact@v3
        with:
          name: pr_info
          path: pr_info.txt
      - name: Preview pr_info.txt content
        run: |
          cat pr_info.txt

  validate-pr:
    needs: analyze-pr-description
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Download PR information
        uses: actions/download-artifact@v3
        with:
          name: pr_info
          path: .

      - name: Load PR information from file
        run: |
          source pr_info.txt
          echo "Loaded variables from pr_info.txt"
          echo "Language: $LANGUAGE"
          echo "Exercises: $EXERCISES"
          echo "PR Number: $PR_NUMBER"

      - name: Run validate-pr script
        run: |
          chmod +x ./scripts/validate-pr.sh
          ./scripts/validate-pr.sh "$LANGUAGE" "$EXERCISES" # Pasa el lenguaje y ejercicios como parámetros

          echo "error_flag=${ERROR_FLAG}" > validation_result.txt
          echo "error_messages=${ERROR_MESSAGES}" >> validation_result.txt

      - name: Upload validation results as artifact
        uses: actions/upload-artifact@v3
        with:
          name: validation_results
          path: validation_result.txt

  post-results:
    needs: validate-pr
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Download validation results
        uses: actions/download-artifact@v3
        with:
          name: validation_results
          path: .

      - name: Run post-results script
        run: |
          source validation_result.txt
          chmod +x ./scripts/post-results.sh
          ./scripts/post-results.sh "$ERROR_FLAG" "$ERROR_MESSAGES" "$PR_NUMBER"

  close-pr:
    needs: post-results
    if: ${{ needs.post-results.outputs.error_flag == '1' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Run close-pr script
        run: |
          chmod +x ./scripts/close-pr.sh
          ./scripts/close-pr.sh "$PR_NUMBER" # Pasa el pr_number como parámetro
