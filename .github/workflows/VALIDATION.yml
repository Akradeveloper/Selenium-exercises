name: PR Validation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  analyze-pr-description:
    runs-on: ubuntu-latest
    outputs:
      workflow_info_path: ${{ steps.save-pr-info.outputs.workflow_info_path }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Run analyze-pr-description script
        id: analyze-pr
        run: |
          chmod +x ./scripts/analyze-pr-description.sh
          ./scripts/analyze-pr-description.sh "${{ github.event.pull_request.body }}"

          # Guardar informaciÃ³n relevante en un archivo
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" > workflow_info.env
          echo "LANGUAGE=$(cat language.txt)" >> workflow_info.env
          echo "MARKED_EXERCISES=$(cat exercises.txt)" >> workflow_info.env
          echo "ERROR_FLAG=0" >> workflow_info.env
          echo "ERROR_MESSAGES=" >> workflow_info.env

      - name: Upload PR information as artifact
        uses: actions/upload-artifact@v3
        with:
          name: workflow_info
          path: workflow_info.env

  validate-pr:
    needs: analyze-pr-description
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Download workflow information
        uses: actions/download-artifact@v3
        with:
          name: workflow_info
          path: .

      - name: Load workflow information
        run: |
          source workflow_info.env
          echo "Loaded variables:"
          echo "PR Number: $PR_NUMBER"
          echo "Language: $LANGUAGE"
          echo "Exercises: $MARKED_EXERCISES"

      - name: Run validate-pr script
        run: |
          chmod +x ./scripts/validate-pr.sh
          ./scripts/validate-pr.sh "$LANGUAGE" "$MARKED_EXERCISES"

          # Agregar errores al archivo
          echo "ERROR_FLAG=1" >> workflow_info.env
          echo "ERROR_MESSAGES=${ERROR_MESSAGES} | Validation errors found" >> workflow_info.env

      - name: Upload updated workflow information
        uses: actions/upload-artifact@v3
        with:
          name: workflow_info
          path: workflow_info.env

  post-results:
    needs: validate-pr
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Download workflow information
        uses: actions/download-artifact@v3
        with:
          name: workflow_info
          path: .

      - name: Run post-results script
        run: |
          source workflow_info.env
          chmod +x ./scripts/post-results.sh
          ./scripts/post-results.sh "$ERROR_FLAG" "$ERROR_MESSAGES" "$PR_NUMBER"

          # Actualizar archivo si es necesario
          echo "Post-results script executed." >> workflow_info.env

      - name: Upload final workflow information
        uses: actions/upload-artifact@v3
        with:
          name: workflow_info
          path: workflow_info.env

  close-pr:
    needs: post-results
    if: ${{ needs.post-results.outputs.error_flag == '1' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Download workflow information
        uses: actions/download-artifact@v3
        with:
          name: workflow_info
          path: .

      - name: Run close-pr script
        run: |
          source workflow_info.env
          chmod +x ./scripts/close-pr.sh
          ./scripts/close-pr.sh "$PR_NUMBER"
