name: Post Results to PR

on:
  workflow_run:
    workflows: ["Validate Exercises"]
    types:
      - completed

jobs:
  post-results:
    runs-on: ubuntu-latest

    steps:
      - name: Get validation results
        id: get_validation_results
        run: |
          # Se deben obtener las variables ERROR_FLAG y ERROR_MESSAGES de algún paso anterior
          ERROR_FLAG=${{ github.event.workflow_run.outputs.error_flag }}
          ERROR_MESSAGES=${{ github.event.workflow_run.outputs.error_messages }}

          if [ "$ERROR_FLAG" -eq "1" ]; then
            # Publicar comentario de error en PR
            curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -d "{\"body\": \"❌ Errores encontrados en la validación del PR:\n$ERROR_MESSAGES\"}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
          else
            # Publicar comentario de éxito en PR
            curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -d "{\"body\": \"✅ Validación completada sin errores.\"}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
          fi

          # Exportar estado para el siguiente workflow
          echo "::set-output name=should_close::${ERROR_FLAG}"

      - name: Set output for should_close
        run: |
          echo "should_close=${{ steps.get_validation_results.outputs.should_close }}" >> $GITHUB_ENV
